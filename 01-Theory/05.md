# Tema 5. Компютърни архитектури. Формати на данните. Вътрешна структура на централен процесор - блокове и конвейерна обработка, инструкции. 

Анотация:
- Oбща структура на компютрите и концептуално изпълнение на инструкциите,запомнена програма.
- Формати на данните
    - цели двоични числа;
    - двоично-десетични числа;
    - двоични числа с плаваща запетая;
    - символни данни и кодови таблици.
- Вътрешна структура на централен процесор
    - регистри;
    - аритметико-логическо устройство;
    - регистър на състоянието и флагове;
    - блок за управление.
- Инструкции на централен процесор
    - префикси;
    - код на операцията;
    - местоположение на операндите;
    - модели на адресация на операндите;
    - аритметико-логически инструкции;
    - низови инструкции;
    - безусловни и условни преходи;
    - управление на програмата.


## Обща структура на компютрите 

### Дефиниция и характеристики на персоналния компютър
Персонален компютър (ПК) представлява универсална цифрова изчислителна система, предназначена за решаване на разнообразни алгоритмични задачи.

Основните характеристики на персоналните компютри включват:
- Компактни размери - позволява употреба в индивидуална или офис среда;
- Относително проста архитектура - опростен хардуерен и софтуерен модел;
- Ограничен обем на оперативната памет - сравнено със сървърни или мейнфрейм системи;
- Набор от базови команди - осигурява изпълнение на основни операции;
- Унифициран входно-изходен интерфейс - улеснява свързването и управлението на периферни устройства.

### Основни хардуерни компоненти
Въпреки разнообразието от хардуерни и софтуерни производители, персоналните компютри обикновено следват общоприет архитектурен модел, базиран на класическата архитектура на фон Нойман. Тази структура включва няколко основни компонента:
- Централен процесор (ЦП, CPU)
    - Централният процесор представлява основният изчислителен и управляващ елемент на компютъра.
    - Той изпълнява инструкции, извлича и обработва данни, управлява комуникацията с останалите компоненти и контролира последователността на програмното изпълнение.
- Паметова система
    - Паметта е логически разделена на няколко вида, според предназначението и характеристиките на съхраняваната информация:
    - Вътрешна памет
        - използва се от процесора за временно съхранение на инструкции и данни по време на изпълнение;
    - Оперативна памет (RAM)
        - временно съхранява активни програми, данни и резултати от текущи операции.
        - Данните в RAM се губят при изключване на системата;
    - Постоянна памет (ROM)
        - съдържа неизменяем код, като например BIOS/UEFI, който се използва при инициализация на компютъра;
    - Външна памет
        - осигурява дългосрочно и устойчиво съхранение на информация.
        - Типични носители включват твърди дискове (HDD), флаш памети и твърдотелни дискове (SSD).
- Периферни устройства (входно-изходни устройства)
    - Това са устройства, чрез които компютърът взаимодейства с външната среда - осъществява се въвеждане и извеждане на информация.
    - Те се делят на:
        - Входни устройства - мишка, клавиатура, скенер, микрофон;
        - Изходни устройства - монитор, принтер, говорители;
        - Комбинирани (I/O) - сензорни екрани, външни дискове, мрежови интерфейси и др.
- Мрежов интерфейс (Network Interface Card, NIC)
    - NIC е специализиран хардуерен модул, който осигурява връзка между компютъра и локални или глобални мрежи (LAN, WAN, интернет).
    - Той поддържа стандарти като Ethernet, Wi-Fi и др.


### Организация на комуникацията между компонентите
Обменът на данни, команди и управляващи сигнали между хардуерните модули се извършва по т.нар. информационни линии или интерфейсни канали, обединени в шина (bus). Съществуват две основни организационни схеми:
- Индивидуални (точка-точка) канали
    - Всеки компонент се свързва директно с всеки друг чрез отделен канал, като се формира пълен граф на свързаност.
    - Предимства: висока скорост на обмен, паралелна комуникация;
    - Недостатъци: сложност на реализацията, висока цена и лоша мащабируемост.
- Обща (споделена) шина
    - Компонентите използват една обща комуникационна линия за предаване на данни, управлявана от централен арбитър. Шината е разделена на три подшини:
        - Шина за данни (Data Bus) - пренася информация между устройствата;
        - Адресна шина (Address Bus) - указва местоположението на данни или инструкции;
        - Управляваща шина (Control Bus) - осигурява сигнализация и синхронизация.
    - Предимства: проста реализация, ниска цена, лесна възможност за надграждане;
    - Недостатъци: възможност за комуникация само между два компонента в даден момент → ограничена производителност при натоварване.
    ![Шина-Пример](/01-Theory/Images/Computer-Bus.png)

## Шинна организация в компютърната система

### Обща характеристика на шината
Шината представлява комуникационна магистрала (информационен канал), чрез която се осъществява обмен на данни, адреси и управляващи сигнали между основните компоненти на компютърната система: централния процесор (CPU), паметта и входно-изходните устройства.

Шината е споделен ресурс, което означава, че всички компоненти, които трябва да осъществят обмен на информация, използват една и съща физическа линия за комуникация. За да се избегнат конфликти при достъп, се прилага арбитраж - механизъм за контрол на достъпа до шината.

### Aрбитраж и управление на шината
Поради конкурентния достъп на множество устройства до шината, е необходимо въвеждането на контролер на шината (или арбитър). Това е специализирано хардуерно устройство или логическа схема, която:
- определя реда и приоритета на устройствата, заявяващи достъп до шината;
- осигурява гарантирано време за достъп до ресурса;
- предотвратява конфликтни състояния, като разрешава достъп само на едно устройство в даден момент.
Обикновено централният процесор има най-висок приоритет при заявка за достъп до шината.

### Логическа структура на шината
Шината е логически разделена на три основни подшини, всяка от които изпълнява конкретна функция:
-  Подшина за данни (Data Bus)
    - Пренася информационни битове между процесора, паметта и входно-изходните устройства.
    - Представлява двупосочен канал, тъй като данните могат да се четат и записват.
    - Ширината на тази подшина определя размерността на еднократно предаваните данни (напр. 32, 64 или 128 бита).
- Подшина за адреси (Address Bus)
    - Пренася адресна информация, която указва точното местоположение на данни или инструкции в паметта или на периферните устройства.
    - Представлява еднопосочен канал - от процесора към останалите компоненти.
    - Ширината на адресната шина определя максималния обем от адресируемата памет:
        - 16-битова адресна шина → до 2¹⁶ = 65 536 адреса (64 KB);
        - 32-битова шина → до 2³² = 4 GB;
        - 64-битова шина → до 2⁶⁴ = 18.4 EB (теоретично).
- Управляваща подшина (Control Bus)
    - Пренася управляващи сигнали за синхронизация и координация на комуникацията.
    - Съдържа линии за:
        - четене (Read) и запис (Write) - указват посоката на трансфер на данни;
        - сигнали за синхронизация (Clock) - управляват темпоралната последователност на операциите;
        - прекъсвания (Interrupts) - уведомяват процесора за външни събития;
        - други контролни линии (например за избор на устройства - Chip Select и др.).

### Основни характеристики на шината
- Ширина на подшината за данни
    - Определя брой битове, които могат да се пренасят едновременно.
    - Пряко влияе върху пропускателната способност на системата.
    - Например: 64-битова шина → може да пренася 8 байта наведнъж.
-  Ширина на подшината за адреси
    - Определя обема на адресируемата памет.
    - Всяка допълнителна линия удвоява броя на адресите, които могат да бъдат различавани.
- Скорост на шината
    - Измерва се в MHz или GHz и указва колко операции за пренос на информация могат да се извършат в секунда.
    - Влияе върху общата производителност на компютърната система.
    - Например: шина, работеща на 100 MHz, може теоретично да извърши 100 милиона трансфера в секунда.

## Формати на данните в компютърните системи

### Представяне на данни в паметта
Всички данни в компютърната памет се представят в двоичен вид - чрез поредици от 0 и 1.

С помощта на `n`-битово поле могат да се представят точно `2^n` различни стойности.

### Цели двоични числа
- Прав код (Signed Magnitude)
    - Най-старшият бит е знаков:
        - `0` - положително число
        - `1` - отрицателно число
    - Останалите `n - 1` бита представляват абсолютната стойност.
    - Диапазон на представимите стойности при `n` бита: `от -(2^(n-1) - 1) до (2^(n-1) - 1)`
    - - Нулата има двойно представяне: `00...0` и `10...0`
    - Недостатък: трудно реализируеми операции по събиране и изваждане.
-  Обратен код (One's Complement)
    - Знаков бит: както при правия код.
    - Отрицателните числа се представят чрез инвертиране на всички битове на абсолютната стойност.
    - Диапазон: `от -(2^(n-1) - 1) до (2^(n-1) - 1)`
    - Нулата отново има двойно представяне: `00...0` и `11...1`
    - Предимство: по-ефективно аритметично обработване - при събиране, ако има пренос от старшия бит, той се прибавя към резултата.
- Допълнителен код (Two's Complement)
    - Отрицателните числа се представят чрез:
    - Инвертиране на абсолютната стойност
    - Добавяне на `1`
    - Диапазон: `от -2^(n-1) до 2^(n-1) - 1`
    - Нулата има единствено представяне: `00...0`
    - Най-ефективен за аритметика - преносът от старшия бит се игнорира.

### Двоично-десетични числа (BCD - Binary Coded Decimal)

- Всяка десетична цифра (0-9) се представя чрез четири бита.
- Остават 6 неизползвани комбинации (от 16).
- Два начина за съхранение:
    - Непакетиран формат: всяка цифра - в отделен байт.
    - Пакетиран формат: по две цифри - в един байт.
        -  в пакетиран формат, всеки байт съдържа по две десетични цифри, а последният байт може да съдържа знак.
- Предимство: по-лесно изваждане.
- Недостатък: по-сложни аритметични операции.

### Двоични числа с плаваща запетая
Реалните числа се представят в паметта като рационални апроксимации.

- Фиксирана запетая
    - В `n`-битово поле:
    - Първите `m` бита - цяла част
    - Останалите `n - m` - дробна част
    - Проблем: неефективно използване на битовете; недостатъчна точност.
-  Плаваща запетая (Floating Point)
    - Представяне: `m × 2^p`
        - `m` - мантиса
        - `p` - порядък (експонента)
        - Нормализирана форма: най-старшият бит на мантисата е `1`.
    - 32 бита (Single Precision):
        - 1 бит за знак
        - 8 бита за експонента
        - 23 бита за мантисата
    - 64 бита (Double Precision):
        - 1 бит за знак
        - 11 бита за експонента
        - 52 бита за мантисата
    - Нормализация: изместване на мантисата наляво и компенсиране чрез намаляване на експонентата.
![Binary-Representation-Floating-Points.png](/01-Theory/Images/Binary-Representation-Floating-Points.png)

### Символни данни и кодови таблици
- Всеки символ се представя чрез битова последователност по кодова таблица.
- Основни кодови таблици:
    - ASCII (American Standard Code for Information Interchange):
        - 7-битова таблица (0-127)
        - Разширен ASCII: 8 бита (128-255 - регионално специфични символи)
    - ANSI - стандарт за кодировка, базиран на ASCII.
    - EBCDIC (Extended Binary Coded Decimal Interchange Code) - 8-битова таблица, използвана от IBM.
    - UNICODE - 16-битова кодова таблица, обхващаща почти всички символи от световните езици.
- Визуализация на символи - знаков итератор
    - Състои се от:
        - Памет с матрици, където всеки символ е графично описан чрез кодирани пиксели (0 и 1).
        - Всеки графичен символ се визуализира чрез двоичен код, който избира съответната матрица.
![Symbol-Interpretator](/01-Theory/Images/Symbol-Interpretator.png)

## Вътрешна структура на централен процесор

### Основни компоненти на ЦП
Централният процесор (ЦП) е основен компонент в архитектурата на персоналния компютър. Всяка задача, която се изпълнява от компютъра, директно или индиректно се управлява от ЦП. Той реализира машинните команди (инструкции).

Негови съставни части са:
- Управляващо устройство (УУ)
- Аритметико-логическо устройство (АЛУ)
- Регистри
- Блок за работа с числа с плаваща запетая и др.

### Регистри

Регистрите са свръхбърза памет, използвана за съхраняване на информация, върху която се извършват логически и аритметични операции. Информацията се съхранява, докато:
- Процесорът е под напрежение
- Някоя машинна команда не я измени

#### Видове регистри:
- Регистри с общо предназначение: `R1, R2, ..., Rn` - използват се за междинни резултати и адресация.
- Регистри за работа с плаваща аритметика
    - понякога са наричани „регистри на FPU“ (Floating Point Unit).
- Служебни регистри:
  - Флагов регистър - информация за:
    - препълване
    - пренос
    - посока на обработка на низове
    - маскиране на прекъсвания и др.
  - PC (Program Counter) - програмен брояч (сочи към следващата инструкция)
  - SP (Stack Pointer) - стеков указател (сочи към върха на програмния стек)
  - MSW (Machine Status Word) - управляващи флагове за синхронизация с външни устройства и ОС
  - MAR (Memory Address Register) - съдържа адреса в паметта на следващата команда
  - MBR (Memory Buffer Register) - буфер между ЦП и RAM, позволява независима работа

### Действие на процесора

Процесорът обработва инструкциите последователно.

Регистърът PC сочи към следващата инструкция в паметта. Всяка команда се извлича чрез IR (Instruction Register), след което се изпълнява.

Аритметически и логически операции се извършват от АЛУ, чиято основна част е двоичният суматор.

#### Управляващо устройство (УУ)
- Извлича командата
- Синхронизира работата на всички вътрешни блокове
- Издава импулси към АЛУ

#### Блок за числа с плаваща запетая
- Извършва аритметични операции върху числа с плаваща точка
- Включва няколко АЛУ за сложна обработка

## Концептуално изпълнение на инструкциите (Основен цикъл)
ЦП изпълнява машинна команда чрез последователност от 8 стъпки.

### Стъпки 1-3: Управляващо устройство (УУ)
1. Извличане на командата: Адресиране и зареждане в IR по адреса в PC
2. Обновяване на PC: Увеличава се с дължината на инструкцията (придвижване напред)
3. Дешифриране на командата: Определяне на:
   - Вид на операцията
   - Брой и тип операнди
   - Размер на данните

### Стъпки 4-7: Аритметико-логическо устройство (АЛУ)
4. Локализация на операндите: Според командата и типа адресация
5. Извличане на операндите: Зареждат се във вътрешни регистри (напр. MBR)
6. Изпълнение на операцията
7. Запис на резултата: В съответната клетка от паметта

### Стъпка 8: Обработка на прекъсвания
8. Проверка за прекъсвания:
   - Ако има, управлението се предава на хардуерния авариен механизъм
   - След това процесът продължава от стъпка 1

## Типове команди

### Аритметико-логически команди
Изпълняват се върху цели числа (със или без знак). Включват:
- Булеви операции:
  - Конюнкция (AND)
  - Дизюнкция (OR)
  - Отрицание (NOT)
  - Сума по модул 2 (XOR)
- Операции за сравнение:
  - `=`, `≠`, `>`, `<`, `≥`, `≤`
- Аритметични операции:
  - `+`, `−`, `*`, `div`, `mod` и др.

### Инструкции за преход
Изменят последователното изпълнение на програмата чрез промяна на стойността на PC (Program Counter):
- Безусловен преход
- Условен преход
- Извикване на подпрограма
- Връщане от подпрограма

### Управляващи команди
Изпълняват се в привилегирован режим, напр.:
- Четене/писане в служебни регистри
- Обработка на прекъсвания
- Изпълнение на системни програми (част от ОС)

### Транспортни команди
Използват се за прехвърляне на данни:
- Между области на паметта
- От/в регистрите

### Допълнителни типове команди:
- Операции с числа с плаваща точка: събиране, изваждане, умножение, деление, степенуване, коренуване и др.
- Операции върху низове: прехвърляне, сравнение, конкатенация
- Мултимедийни операции (MMX): векторни операции, използвани при обработка на изображения

## Запомнена програма

Процесорът изпълнява и реализира командите на дадена програма. Във всеки момент тя се намира в някакво състояние от своето изпълнение.

### Състояние на процеса (векторно състояние)
Векторното състояние съдържа пълната информация, необходима за възобновяване на спрян процес, така че да продължи без загуба на данни или контекст.

Включва:
1. Състоянието на програмата (кодът към момента на спиране)
2. Състоянието на областите с данни
3. Съдържание на управляващите таблици на ОС
4. Съдържание на регистрите на процеса
5. Състояние на входно-изходните устройства

Важно: Програмите не трябва да се променят по време на изпълнение - това се счита за лош стил на програмиране.

## Терминологичен речник

| Съкращение | Значение |
|------------|----------|
| HDD | Hard Disk Drive |
| SSD | Solid State Drive |
| RAM | Random Access Memory |
| ROM | Read Only Memory |
| NIC | Network Interface Card |
| ANSI | American National Standards Institute |
| ASCII | American Standard Code for Information Interchange |
| EBCDIC | Extended Binary-Coded Decimal Interchange Code |
| MBR | Master Boot Record - информация в първия сектор на твърд диск или сменяемо устройство, идентифицираща ОС |
| MMX | Matrix Math Extensions - разширения за векторна математика, използвани при обработка на изображения |
