# Teма 6: Структура и йерархия на паметта. Сегментна и странична преадресация. Система за прекъсване - приоритети и обслужване.

## Памет в компютърните системи (Въведение)
Паметта в един персонален компютър представлява място за съхранение на данни и инструкции, които се използват от програмите по време на тяхното изпълнение.

На най-ниско ниво тя е изградена от битове - логически единици с два възможни състояния: 0 или 1.

Битът е най-малката мерна единица за измерване на информация. Поради по-голямата си практичност, в съвременните компютри основната адресируема единица е байтът, който се състои от 8 бита. Капацитетът на компютърната памет се измерва именно в байтове.

## Йерархия на паметта
Компютърната памет е организирана йерархично, като различните нива отговарят на различни изисквания по отношение на скорост, капацитет и цена за единица информация. Тази йерархия позволява на процесора да използва различните нива според необходимостта от бързодействие и достъпност.

![Memory-Hierarchy-Diagram](/01-Theory/Images/Memory-Hierarchy-Diagram.png)

### Вътрешна и външна памет:
- Външна (вторична) памет
    - Това е памет, която не е пряко достъпна от процесора и се използва за дългосрочно съхранение на данни.
    - Достъпът до нея се осъществява чрез входно-изходни модули. Основните видове външна памет включват:
        - Магнитни дискове (твърди дискове, HDD)
        - Оптични дискове (CD, DVD)
        - Магнитни ленти
- Вътрешна (първична) памет
    - Тази памет е пряко достъпна от процесора и се използва за съхраняване на данни и инструкции, необходими по време на изпълнение на програмите.
    - Основните видове вътрешна памет са:
        - Регистри - най-бързата памет, разположена вътре в процесора
        - Кеш памет - междинна, високоскоростна памет, служеща за буфериране между основната памет и регистрите
        - Основна памет (RAM) - оперативната памет, в която се зареждат програмите и данните по време на работа

### Характеристики на паметта по нива от йерархията
С напредването в йерархията (от регистрите към външната памет) се наблюдават следните закономерности:
- Капацитет
    - увеличава се с всяко следващо по-ниско ниво от йерархията.
    - Например, външната памет има значително по-голям капацитет от кеша или регистрите.
- Време за достъп
    - намалява при преминаване към по-високи нива.
    - Регистрите осигуряват най-бърз достъп, докато външната памет е най-бавна.
- Цена за бит
    - най-висока при най-бързите и малки по капацитет памети (напр. регистри) и най-ниска при външната памет.

### Кеш памет (Cache Memory)
Кеш паметта представлява високоскоростна вътрешна памет, предназначена за ускоряване на достъпа на централния процесор (ЦП) до често използвани данни и инструкции. Благодарение на близостта си до процесора и архитектурната си оптимизация, кеш паметта осигурява значително по-бърз достъп в сравнение с оперативната и външната памет.

Кешът съхранява данни, които са били наскоро използвани или се използват често, така че при повторен достъп ЦП не трябва да се обръща към по-бавните нива от паметната йерархия. Поради високата си производителност, кеш паметта е по-скъпа на единица обем и има по-малък капацитет от другите видове памет.

#### Нива на кеш паметта
Кеш паметта е организирана на няколко нива:
- L1 (Level 1)
    - най-бърза, но с най-малък капацитет (обикновено между 8 и 64 KB). Разделя се на:
        - Кеш с инструкции – съхранява машинни инструкции
        - Кеш с данни – съхранява стойности, с които работят инструкциите
- L2 (Level 2)
    - по-бавна от L1, но с по-голям капацитет (обикновено стотици KB)
- L3 (Level 3)
    - най-бавна от кешовите нива, но с най-голям капацитет (може да достига няколко MB)

Обикновено всяко ядро на съвременен процесор притежава собствен L1 и L2 кеш, докато L3 кешът е споделен между всички ядра.

#### Cache Hit и Cache Miss
Когато процесорът търси дадени данни, той първо проверява кеша:
- Cache hit – данните се намират в кеша, достъпът е бърз.
- Cache miss – данните не са налични в кеша; налага се извличането им от RAM паметта, след което кешът се актуализира.

Съотношението на попаденията (hit ratio) се използва като метрика за ефективността на кеша и се изчислява по формулата:
```bash
Hit ratio = Hits Count / (hits count + miss count)
```
По-високото съотношение показва по-добра ефективност на кеша и е цел на редица оптимизационни техники.

### Оперативна памет (RAM – Random Access Memory)
Оперативната памет съхранява инструкции за изпълнение от процесора и данни, върху които те оперират. Основната ѝ характеристика е, че предоставя произволен достъп – т.е. времето за достъп до всяка клетка памет е приблизително еднакво, независимо от местоположението на данните.

RAM е летлива памет, което означава, че при загуба на електрическо захранване цялото съдържание се изтрива.

#### Видове RAM
RAM паметта се дели на два основни типа:
- SRAM (Static RAM):
    - Използва се основно за кеш памет
    - Съхранява информацията без нужда от периодично опресняване
    - Използва по-сложна схема (обикновено 6 транзистора на клетка)
    - По-бърза и по-скъпа
- DRAM (Dynamic RAM):
    - Използва се като основна оперативна памет
    - Изисква периодично опресняване на данните
    - По-проста конструкция (1 транзистор и 1 кондензатор на клетка)
    - По-евтина и с по-голям капацитет

### Виртуална памет
Виртуалната памет е механизъм, чрез който част от външната памет (обикновено твърдият диск) се използва като разширение на RAM. Тя дава възможност на компютъра да работи с повече данни, отколкото физическата RAM може да побере.

Когато RAM паметта се изчерпи, операционната система прехвърля част от данните от RAM към виртуалната памет (в т.нар. swap файл или странична памет), освобождавайки място за активните процеси. Така на програмите се създава илюзия, че разполагат с повече оперативна памет.

За да се постигне това, се използва виртуално адресиране, при което виртуалните адреси се преобразуват към физически адреси чрез специализирани хардуерни модули (например MMU – Memory Management Unit).

Недостатък на виртуалната памет е, че достъпът до нея е значително по-бавен, тъй като тя се намира върху външна памет, а не в RAM.

## Сегментна и странична преадресация

### Странична преадресация (Paging)
Страничната преадресация е техника за управление на виртуалната памет, при която виртуалното адресно пространство (ВАП) на процеса се разделя на равномерни фрагменти, наречени страници, а физическото адресно пространство (ФАП) – на блокове (или рамки).

Тази техника позволява на процесите да работят с по-голямо и непрекъснато логическо адресно пространство, независимо от реалната структура на физическата памет.

#### Таблица на страниците (Page Table)
Операционната система поддържа таблица на страниците, в която се съхранява съответствието между виртуалните страници и физическите блокове. Всеки запис в таблицата съдържа:
- Бит за наличност (Present bit): показва дали страницата се намира във физическата памет;
- Бит за модификация (Dirty/Modified bit): указва дали страницата е била променена;
- Номер на блока, в който е заредена страницата.

Виртуалният адрес се състои от:
- Номер на виртуална страница;
- Отместване в рамките на страницата.

Транслацията се осъществява на два етапа:
- Намиране на физически блок чрез таблицата на страниците, базирано на номера на виртуалната страница;
- Прибавяне на отместването за получаване на крайния физически адрес.

Ако страницата не се намира в основната памет, тя се зарежда от диска (вторична памет). При липса на свободно място се извършва заместване на страница, като се изтласква друга страница обратно към диска, ако е необходимо.

Най-често използваните записи в таблицата се кешират в специализиран буфер – TLB (Translation Lookaside Buffer) – с цел ускоряване на транслацията.

### Сегментна преадресация (Segmentation)
При сегментацията виртуалното адресно пространство се разделя на сегменти с променлива дължина, които могат да се припокриват и имат логическо значение – напр. код, данни, стек и др.

Всеки сегмент се описва чрез:
- Базов адрес (начален физически адрес);
- Дължина на сегмента.

Адресирането се извършва чрез:
- Селектор на сегмент – указва кой сегмент се използва;
- Отместване в сегмента – позиция в рамките на сегмента.

Селекторът на сегмента съдържа индекс и флаг за вида на таблицата – глобална (GDT) или локална (LDT):
- GDT (Global Descriptor Table) – обща за цялата система, използва се за системни сегменти;
- LDT (Local Descriptor Table) – отделна за всеки процес, използва се за приложни сегменти.

Таблиците съдържат сегментни дескриптори, които описват:
- Начален адрес;
- Размер;
- Атрибути за достъп и защита.

Процес на транслация
- Определяне на таблицата – GDT или LDT;
- Извличане на базовия адрес от сегментния дескриптор;
- Прибавяне на отместването – получава се линеен адрес;
- Ако се използва странична преадресация, линейният адрес се подава към страничния механизъм за допълнителна транслация към физически адрес.

Ако отместването надвишава дължината на сегмента, системата генерира изключение – това осигурява сегментна защита и предпазва от некоректен достъп до паметта.

Модерните системи често използват комбинирана схема:
- Сегментацията осигурява логическа структура и защита;
- Страничната преадресация осигурява ефективно управление на физическата памет.
Полученият линеен адрес от сегментната транслация се обработва допълнително от страничната схема, за да се получи крайният физически адрес.

## Прекъсвания

### Обща характеристика
Прекъсването е механизъм, при който процесорът временно прекратява текущото изпълнение на програма, за да обработи възникнало събитие с по-висок приоритет. Това става чрез:
- Съхранение на текущото състояние (програмен брояч и регистър на състоянието) в стека;
- Преминаване към адрес в паметта, указващ програма за обработка на прекъсването;
- Възстановяване на предишното състояние след приключване на обработката чрез специална инструкция (напр. IRET при x86).

Целта е системата да реагира ефективно на събития като вход/изход, грешки или заявки от други устройства, без да се налага непрекъснато да ги проверява активно (polling).

### Векторна таблица на прекъсванията
В основната памет се намира таблица на векторите на прекъсванията – структура, в която:
- Всеки запис (вектор) отговаря на определен тип прекъсване;
- Съдържа указател към подпрограма за обслужване на прекъсването;
- Адресите са фиксирани и достъпни чрез номер на прекъсването.

### Видове прекъсвания
Прекъсванията могат да бъдат класифицирани по произход:
- По машинна грешка (hardware fault)
    - Най-висок приоритет;
    - Пример: грешка в паметта, повреда в устройство.
- Входно-изходни прекъсвания
    - Възникват при завършване или необходимост от I/O операция.
- Външни прекъсвания
    - Пример: таймер, клавиатура, мишка – аналогични на входно-изходните.
- Програмни прекъсвания
    - Генерирани от текущата програма – напр. деление на нула, невалидна инструкция.
- SVC (Supervisor Call)
    - Умишлено активирано прекъсване от програмата за достъп до операционни услуги.

### Маскируеми и немаскируеми прекъсвания
Маскируеми прекъсвания
- Могат да бъдат забранени временно от процесора чрез специални флагове.
- Например: повечето I/O прекъсвания.

Немаскируеми прекъсвания (NMI)
- Не могат да бъдат игнорирани.
- Обикновено се използват за критични събития – напр. хардуерни повреди.

### Приоритет и вложени прекъсвания
Всеки тип прекъсване има определен приоритет – по-малък номер означава по-висок приоритет.
Обработката на прекъсване може да бъде прекъсната само от събитие с по-висок приоритет.
Примерен ред на обслужване:
- Инструкции INT (софтуерни прекъсвания) и специални събития;
- Прекъсване в стъпков режим (debug);
- Немаскируеми прекъсвания;
- Маскируеми прекъсвания.

### Контролер на прекъсванията
Контролерът на прекъсванията е специално логическо устройство, което:
- Получава заявки от различни хардуерни устройства;
- Управлява линиите IRQ (Interrupt Request);
- Определя приоритета на заявките;
- Редува и насочва прекъсванията към процесора.

Контролерът осигурява централизирано и приоритетно управление върху прекъсванията, като:
- Предотвратява хаотичен достъп до процесора;
- Намалява загубата на време и данни от външни устройства;
- Позволява вложени прекъсвания при нужда.
- Недостатък: възможно е програма да забрани прекъсванията и да блокира обработката им временно.